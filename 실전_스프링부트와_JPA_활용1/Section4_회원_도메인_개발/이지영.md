# íšŒì› ë„ë©”ì¸ ê°œë°œ

# ğŸ® íšŒì› ë„ë©”ì¸ ê°œë°œ

- íšŒì› Repository
    
    ```java
    package com.jpabook.jpashop.repository;
    
    import com.jpabook.jpashop.domain.Member;
    import jakarta.persistence.EntityManager;
    import jakarta.persistence.PersistenceContext;
    import org.springframework.stereotype.Repository;
    
    import java.util.List;
    
    @Repository
    public class MemberRepository {
    
        @PersistenceContext // EntityManager ìë™ ì£¼ì…
        private EntityManager em;
    
        public void save(Member member){
            em.persist(member);// íŠ¸ëœì­ì…˜ ì»¤ë°‹ ì‹œì ì— dbë°˜ì˜, insertì¿¼ë¦¬ë‚ ë¼ê°
        }
    
        public Member findOne(Long id){
            return em.find(Member.class,id);
        }
    
        public List<Member> findAll(){
            return em.createQuery("select m from Member m", Member.class)
                    .getResultList();
        }
    
        public List<Member> findByName(String name){
            return em.createQuery("select m from Member m where m.name", Member.class)
                    .setParameter("name",name)
                    .getResultList();
        }
    }
    ```
    
- íšŒì› ì„œë¹„ìŠ¤
    
    ```java
    package com.jpabook.jpashop.service;
    
    import com.jpabook.jpashop.domain.Member;
    import com.jpabook.jpashop.repository.MemberRepository;
    import org.springframework.beans.factory.annotation.Autowired;
    import org.springframework.stereotype.Service;
    import org.springframework.transaction.annotation.Transactional;
    
    import java.util.List;
    
    @Service
    @Transactional(readOnly = true)
    public class MemberService {
    
        @Autowired
        private MemberRepository memberRepository;
    
        /**
         * íšŒì›ê°€ì…
         */
        @Transactional
        public Long join(Member member){
            validateDuplicateMember(member);
            memberRepository.save(member);
            return member.getId();
        }
    
        //ì¤‘ë³µ íšŒì› ê²€ì¦
        private void validateDuplicateMember(Member member) {
            //EXCEPTION
            List<Member> findMembers = memberRepository.findByName(member.getName());
            if(!findMembers.isEmpty()){
                throw new IllegalStateException("ì´ë¯¸ ì¡´ì¬í•˜ëŠ” íšŒì›ì…ë‹ˆë‹¤.");
            }
        }
    
        //íšŒì› ì „ì²´ ì¡°íšŒ
        public List<Member> fondMembers(){
            return memberRepository.findAll();
        }
    
        public Member findOne(Long memberId){
            return memberRepository.findOne(memberId);
        }
    }
    ```
    
    - `@Transactional(readOnly = true)`  : jpaê°€ ì¡°íšŒí•˜ëŠ”ê³³ì—ì„œëŠ” ì„±ëŠ¥ì„ ìµœì í™”í•¨. ì½ê¸°ì „ìš© íŠ¸ë™ì­ì…˜ì´ë¼ëŠ” ì•Œë¦¼ëŠë‚Œ
        - ì“°ê¸°ì—ì„œëŠ” trueì“°ë©´ ì•ˆë¨. ê¸°ë³¸ì´ falseì´ê¸° ë•Œë¬¸ì— trueí• ê³³ì´ ë§ë‹¤ë©´ ì „ì²´ì ìš© í•´ë†“ê³  ì“°ê¸°ë¶€ë¶„ì—ë§Œ @Transactionì£¼ê¸°!
    - ë™ì‹œì— ê°™ì€ ì´ë¦„ìœ¼ë¡œ íšŒì›ê°€ì…í•˜ëŠ” ê²ƒì„ (ë©€í‹°ìŠ¤ë ˆë“œ) ë°©ì§€í•˜ê¸° ìœ„í•´ ë°ì´í„°ë² ì´ìŠ¤ì— ë©¤ë²„ì˜ ë„¤ì„ì„ ìœ ë‹ˆí¬ì œì•½ì¡°ê±´ ê±¸ê¸° ê¶Œì¥!
    - Setter Injection
        
        ```java
        @Autowired
        private MemberRepository memberRepository; -> ì´ë°©ë²•ì€ í…ŒìŠ¤íŠ¸í•˜ê±°ë‚˜í• ë•Œ ë°”ê¾¸ì§€ ëª»í•˜ê¸° ë•Œë¬¸ì—
        
        // Setter Injection ìŠ¤í”„ë§ì´ ë“¤ì–´ì™€ì„œ ì£¼ì…í•´ì£¼ëŠ” ë°©ë²• -> í…ŒìŠ¤íŠ¸ì½”ë“œê°™ì€ê±¸ í• ë•Œ ê±°ì³ì„œ ë“¤ì–´ì™€ì„œ ê±´ë“œë¦´ ìˆ˜ ìˆìŒ
        // ë‹¨ì ì€ ì¹˜ëª…ì  (ëŸ°íƒ€ì„ì— ì‹¤ì œ applicationëŒì•„ê°€ëŠ” ì‹œì ì— ëˆ„êµ°ê°€ê°€ ë°”ê¿€ìˆ˜ ìˆìŒ. ì˜¬ë¼ì˜¬ë•Œ ì„¸íŒ…ì¡°ë¦½ì´ ëë‚˜ëŠ”ë° ê·¸ ì´í›„ ë°”ê¿€ì¼ì´ì—†ìŒ)
        private MemberRepository memberRepository;
        @Autowired
        public void setMemberRepository(MemberRepository memberRepository) {
            this.memberRepository = memberRepository;
        }
        
        //ê·¸ë˜ì„œ ìš”ì¦˜ ê¶Œì¥í•˜ëŠ” ë°©ë²•ì€ ìƒì„±ì Injectionì„ í•¨.
        //ìŠ¤í”„ë§ì´ ëœ° ë•Œ ìƒì„±ìì—ì„œ ì¸ì ì…˜ì„ í•´ì¤Œ. ì¤‘ê°„ì— ë°”ê¿€ìˆ˜ ì—†ìŒ.
        // í…ŒìŠ¤íŠ¸ì¼€ì´ìŠ¤ ê°™ì€ê±° ì‘ì„±ì‹œì— ì˜ì¡´ê´€ê³„ë¥¼ ëª…í™•íˆ í• ìˆ˜ì‡ìŒ ë‹¨ ì½”ë“œê°€ ë³µì¡í•´ì§„ë‹¨ ë§ì„?
        @Autowired
        public MemberService(MemberRepository memberRepository) {
            this.memberRepository = memberRepository;
        }
        
        //ìƒì„±ìê°€ í•˜ë‚˜ë§Œ ìˆëŠ”ê²½ìš°ì—ëŠ” ìš”ì¦˜ì—” ìë™ìœ¼ë¡œ @Autowiredë¥¼ ë¶™ì´ì§€ì•Šì•„ë„ ìë™ìœ¼ë¡œ ì¸ì­ì…˜ì„ í•´ì¤Œ.
        private final MemberRepository memberRepository; // ê·¸ë¦¬ê³  ì´ê°’ì€ ë³€ê²½í•  ì¼ì´ ì—†ê¸°ë•Œë¬¸ì— finalë¡œ ì„ ì–¸í•˜ëŠ”ê²ƒì„ ê¶Œì¥í•¨.
        public MemberService(MemberRepository memberRepository) {
            this.memberRepository = memberRepository;
        }
        
        //ì—¬ê¸°ì— ë¡¬ë³µì„ ì ìš©í•˜ë©´ @AllArgsConstructor -> í•„ë“œì— ìˆëŠ”ê±¸ ê°€ì§€ê³  ìƒì„±ì ì¸ì ì…˜ì„ ë§Œë“¤ì–´ì¤Œ
        // @RequiredArgsConstructor ì´ê±¸ ì ìš©í•˜ë©´ í•„ë“œì— finalë¡œ ì„ ì–¸í•œê²ƒë§Œ ê°€ì§€ê³  ìƒì„±ìì¸ì­ì…˜ì„ ë§Œë“¤ì–´ì¤Œ
        @Service
        @Transactional(readOnly = true)
        @RequiredArgsConstructor
        public class MemberService {
            private final MemberRepository memberRepository;
        ```
        
- íšŒì› ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸
    - íšŒì›ê°€ì… ì„±ê³µ
    - íšŒì›ê°€ì…ì‹œ ê°™ì€ ì´ë¦„ì´ ìˆìœ¼ë©´ ì˜ˆì™¸ ë°œìƒ
    
    ```java
    package com.jpabook.jpashop.service;
    
    import com.jpabook.jpashop.domain.Member;
    import com.jpabook.jpashop.repository.MemberRepository;
    import jakarta.persistence.EntityManager;
    import org.junit.Test;
    import org.junit.runner.RunWith;
    import org.springframework.beans.factory.annotation.Autowired;
    import org.springframework.boot.test.context.SpringBootTest;
    import org.springframework.test.annotation.Rollback;
    import org.springframework.test.context.junit4.SpringRunner;
    import org.springframework.transaction.annotation.Transactional;
    
    import static org.junit.Assert.*;
    
    @RunWith(SpringRunner.class)
    @SpringBootTest
    @Transactional
    public class MemberServiceTest {
    
        @Autowired
        MemberService memberService;
        @Autowired
        MemberRepository memberRepository;
    
        @Test
        public void íšŒì›ê°€ì…() throws Exception{
            //given
            Member member = new Member();
            member.setName("kim");
    
            //when
            Long saveId = memberService.join(member);
    
            //then
            assertEquals(member, memberRepository.findOne(saveId));
        }
    
        @Test(expected = IllegalStateException.class)
        public void ì¤‘ë³µ_íšŒì›_ì˜ˆì™¸() throws Exception{
            //Given
            Member member1 = new Member();
            member1.setName("kim");
            Member member2 = new Member();
            member2.setName("kim");
    
            //When
            memberService.join(member1);
            memberService.join(member2); //ì˜ˆì™¸ê°€ ë°œìƒí•´ì•¼ í•¨.
    
            //Then
            fail("ì˜ˆì™¸ê°€ ë°œìƒí•´ì•¼ í•œë‹¤.");
    
        }
    }
    ```
    
- ìŠ¤í”„ë§ ë¶€íŠ¼ ì‹¤í–‰ì‹œì— yml ì‹¤í–‰íŒŒì¼ì„ ì½ëŠ”ë° datasource ì„¤ì • ì—†ìœ¼ë©´ ê¸°ë³¸ ë©”ëª¨ë¦¬ dbì‚¬ìš©í•˜ê³  driver-classë„ í˜„ì¬ ë“±ë¡ëœ ë¼ì´ë¸ŒëŸ¬ë¥¼ ë³´ê³  ì°¾ì•„ì¤Œ.
    - ë”°ë¼ì„œ ë°ì´í„° ì†ŒìŠ¤ë‚˜, JPA ê´€ë ¨ëœ ë³„ë„ì˜ ì¶”ê°€ì„¤ì • í•˜ì§€ ì•Šì•„ë„ ë¨.

---
