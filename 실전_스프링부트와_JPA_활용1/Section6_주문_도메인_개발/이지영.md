# ğŸ® ì£¼ë¬¸ ë„ë©”ì¸ ê°œë°œ

- ì£¼ë¬¸, ì£¼ë¬¸ìƒí’ˆ ì—”í‹°í‹°
    
    ```java
    //order ê°ì²´
    //==ìƒì„± ë©”ì„œë“œ==//
    public static Order createOrder(Member member, Delivery delivery,
                                    OrderItem... orderItems) {
        Order order = new Order();
        order.setMember(member);
        order.setDelivery(delivery);
        for (OrderItem orderItem : orderItems) {
            order.addOrderItem(orderItem);
        }
        order.setStatus(OrderStatus.ORDER);
        order.setOrderDate(LocalDateTime.now());
        return order;
    }
    
    //==ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§==//
    //ì£¼ë¬¸ ì·¨ì†Œ
    public void cancel() {
        if (delivery.getStatus() == DeliveryStatus.COMP) {
            throw new IllegalStateException("ì´ë¯¸ ë°°ì†¡ì™„ë£Œëœ ìƒí’ˆì€ ì·¨ì†Œê°€ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤.");
        }
    
        this.setStatus(OrderStatus.CANCEL);
        for (OrderItem orderItem : orderItems) {
            orderItem.cancel();
        }
    }
    
    //==ì¡°íšŒ ë¡œì§==//
    //ì „ì²´ ì£¼ë¬¸ ê°€ê²© ì¡°íšŒ
    public int getTotalPrice() {
        int totalPrice = 0;
        for (OrderItem orderItem : orderItems) {
            totalPrice += orderItem.getTotalPrice();
        }
        return totalPrice;
    }
    
    //order Item
    //==ìƒì„± ë©”ì„œë“œ==//
    public static OrderItem createOrderItem(Item item, int orderPrice, int count) {
        OrderItem orderItem = new OrderItem();
        orderItem.setItem(item);
        orderItem.setOrderPrice(orderPrice);
        orderItem.setCount(count);
        item.removeStock(count);
        return orderItem;
    }
    //==ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§==//
    //ì£¼ë¬¸ ì·¨ì†Œ
    public void cancel() {
        getItem().addStock(count);
    }
    // ì£¼ë¬¸ìƒí’ˆ ì „ì²´ ê°€ê²© ì¡°íšŒ
    public int getTotalPrice() {
        return getOrderPrice()*getCount();
    }
    ```
    
- ì£¼ë¬¸ ë¦¬í¬ì§€í† ë¦¬ ê°œë°œ
    
    ```java
    // orderrepository
    package com.jpabook.jpashop.repository;
    
    import com.jpabook.jpashop.domain.Order;
    import jakarta.persistence.EntityManager;
    import lombok.RequiredArgsConstructor;
    import org.springframework.stereotype.Repository;
    
    @Repository
    @RequiredArgsConstructor
    public class OrderRepository {
        private final EntityManager em;
        public void save(Order order) {
            em.persist(order);
        }
        public Order findOne(Long id) {
            return em.find(Order.class, id);
        }
        // ì´ê±´ ë‚˜ì¤‘ì— ì£¼ë¬¸ê²€ìƒ‰ê¸°ëŠ¥ì— ìì„¸íˆ
        // public List<Order> findAll(OrderSearch orderSearch) {}
    }
    ```
    
- ì£¼ë¬¸ ì„œë¹„ìŠ¤ ê°œë°œ
    - ì£¼ë¬¸ , ì·¨ì†Œ , ê²€ìƒ‰
    
    ```java
    // OrderItem, Order
    @NoArgsConstructor(access= AccessLevel.PROTECTED) -> jpaì“°ë©´ì„œ protectedí•˜ë©´ ì“°ì§€ë§ˆ
    
    // jpaì˜ ê°•ì  = ë³€ê²½ë°ì´í„°ì— ë”°ë¼ì„œ sqlì—…ë°ì´íŠ¸ ì¿¼ë¦¬ë¥¼ ë‚ ë¦¼.
    
    package com.jpabook.jpashop.service;
    
    import com.jpabook.jpashop.domain.*;
    import com.jpabook.jpashop.domain.item.Item;
    import com.jpabook.jpashop.repository.ItemRepository;
    import com.jpabook.jpashop.repository.MemberRepository;
    import com.jpabook.jpashop.repository.OrderRepository;
    import lombok.RequiredArgsConstructor;
    import org.springframework.stereotype.Service;
    import org.springframework.transaction.annotation.Transactional;
    
    @Service
    @Transactional(readOnly = true)
    @RequiredArgsConstructor
    public class OrderService {
        private final MemberRepository memberRepository;
        private final OrderRepository orderRepository;
        private final ItemRepository itemRepository;
    
        //ì£¼ë¬¸
        @Transactional
        public Long order(Long memberId, Long itemId, int count) {
            //ì—”í‹°í‹° ì¡°íšŒ
            Member member = memberRepository.findOne(memberId);
            Item item = itemRepository.findOne(itemId);
    
            //ë°°ì†¡ì •ë³´ ìƒì„±
            Delivery delivery = new Delivery();
            delivery.setAddress(member.getAddress());
    
            //ì£¼ë¬¸ìƒí’ˆ ìƒì„±
            OrderItem orderItem = OrderItem.createOrderItem(item, item.getPrice(), count);
    
            //ì£¼ë¬¸ ìƒì„±
            Order order = Order.createOrder(member, delivery, orderItem);
    
            //ì£¼ë¬¸ ì €ì¥
            orderRepository.save(order);
    
            return order.getId();
        }
    
        //ì£¼ë¬¸ ì·¨ì†Œ
        @Transactional
        public void cancelOrder(Long orderId) {
            //ì£¼ë¬¸ ì—”í‹°í‹° ì¡°íšŒ
            Order order = orderRepository.findOne(orderId);
            //ì£¼ë¬¸ ì·¨ì†Œ
            order.cancel();
        }
    
        //ì£¼ë¬¸ ê²€ìƒ‰
     /*
        public List<Order> findOrders(OrderSearch orderSearch) {
            return orderRepository.findAll(orderSearch);
        }
     */
    }
    ```
    
    - ì„œë¹„ìŠ¤ì˜ ì£¼ë¬¸, ì£¼ë¬¸ì·¨ì†Œì˜ ë¹„ì¦ˆë‹ˆìŠ¤ë¡œì§ì´ ëŒ€ë¶€ë¶„ ì—”í‹°í‹°ì— ìˆìŒ.
        - ì—”í‹°í‹°ê°€ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì„ ê°€ì§€ê³  ê°ì²´ ì§€í–¥ì˜ íŠ¹ì„±ì„ ì ê·¹ í™œìš©í•˜ëŠ” ê²ƒì„ ë„ë©”ì¸ ëª¨ë¸ íŒ¨í„´ì´ë¼ê³  í•¨.
        - ë°˜ëŒ€ë¡œ ì—”í‹°í‹°ì— ê±°ì˜ ì—†ê³  ì„œë¹„ìŠ¤ì— ì²˜ë¦¬í•˜ëŠ”ê²ƒì„ íŠ¸ëœì­ì…˜ ìŠ¤í¬ë¦½íŠ¸ íŒ¨í„´ì´ë¼ê³  í•¨.
        - ì£¼ë¡œ ë„ë©”ì¸ ëª¨ë¸ íŒ¨í„´ì„ ì‚¬ìš©í•¨. ë­ê°€ì¢‹ì€ì§€ ê³ ë¯¼í•´ë³¼ê²ƒ. ë•Œë¡œëŠ” ìŠ¤í¬ë¦½íŠ¸ê°€ ì¢‹ì€ ê²½ìš°ë„ ìˆìŒ.
- ì£¼ë¬¸ ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸
    - ì£¼ë¬¸ì„±ê³µí•´ì•¼í•¨, ì¬ê³ ìˆ˜ëŸ‰ ì´ˆê³¼X, ì·¨ì†Œ ì„±ê³µí•´ì•¼í•¨.
    
    ```java
    @RunWith(SpringRunner.class)
    @SpringBootTest
    @Transactional
    public class OrderServiceTest {
        @PersistenceContext
        EntityManager em;
        @Autowired
        OrderService orderService;
        @Autowired
        OrderRepository orderRepository;
        @Test
        public void ìƒí’ˆì£¼ë¬¸() throws Exception {
            //Given
    //        Member member = createMember();
    //        member.setName("íšŒì› 1");
    //        member.setAddress(new Address("ì„œìš¸", "ê°•ê°€", "123-123"));
    //        em.persist(member);
    //
    //        Book book = new Book();
    //        book.setName("ì‹œê³¨ JPA");
    //        book.setPrice(10000);
    //        book.setStockQuantity(10);
    //        em.persist(book);
    
            Member member = createMember();
            Item item = createBook("ì‹œê³¨ JPA", 10000, 10);
    
            int orderCount = 2;
    
            //When
            Long orderId = orderService.order(member.getId(), item.getId(), orderCount);
    
            //Then
            Order getOrder = orderRepository.findOne(orderId);
            assertEquals("ìƒí’ˆ ì£¼ë¬¸ì‹œ ìƒíƒœëŠ” ORDER", OrderStatus.ORDER, getOrder.getStatus());
            assertEquals("ì£¼ë¬¸í•œ ìƒí’ˆ ì¢…ë¥˜ ìˆ˜ê°€ ì •í™•í•´ì•¼ í•œë‹¤.",1, getOrder.getOrderItems().size());
            assertEquals("ì£¼ë¬¸ ê°€ê²©ì€ ê°€ê²© * ìˆ˜ëŸ‰ì´ë‹¤.", 10000 * 2, getOrder.getTotalPrice());
            assertEquals("ì£¼ë¬¸ ìˆ˜ëŸ‰ë§Œí¼ ì¬ê³ ê°€ ì¤„ì–´ì•¼ í•œë‹¤.",8, item.getStockQuantity());
        }
    
        @Test(expected = NotEnoughStockException.class)
        public void ìƒí’ˆì£¼ë¬¸_ì¬ê³ ìˆ˜ëŸ‰ì´ˆê³¼() throws Exception {
            //given
            Member member = createMember();
            Item item = createBook("ì‹œê³¨ JPA", 10000, 10);
            int orderCount = 2;
            Long orderId = orderService.order(member.getId(), item.getId(), orderCount);
    
            //when
            orderService.cancelOrder(orderId);
    
            //then
            Order getOrder = orderRepository.findOne(orderId);
    
            assertEquals("ì£¼ë¬¸ ì·¨ì†Œì‹œ ìƒíƒœëŠ” CANCEL ì´ë‹¤.",OrderStatus.CANCEL, getOrder.getStatus());
            assertEquals("ì£¼ë¬¸ì´ ì·¨ì†Œëœ ìƒí’ˆì€ ê·¸ë§Œí¼ ì¬ê³ ê°€ ì¦ê°€í•´ì•¼ í•œë‹¤.", 10, item.getStockQuantity());
        }
    
        @Test
        public void ì£¼ë¬¸ì·¨ì†Œ() {
            //Given
            Member member = createMember();
            Item item = createBook("ì‹œê³¨ JPA", 10000, 10);
            int orderCount = 11;
    
            //When
            orderService.order(member.getId(), item.getId(), orderCount);
            //Then
            fail("ì¬ê³  ìˆ˜ëŸ‰ ë¶€ì¡± ì˜ˆì™¸ê°€ ë°œìƒí•´ì•¼ í•œë‹¤.");
        }
    
        private Member createMember() {
            Member member = new Member();
            member.setName("íšŒì›1");
            member.setAddress(new Address("ì„œìš¸", "ê°•ê°€", "123-123"));
            em.persist(member);
            return member;
        }
    
        private Book createBook(String name, int price, int stockQuantity) {
            Book book = new Book();
            book.setName(name);
            book.setStockQuantity(stockQuantity);
            book.setPrice(price);
            em.persist(book);
            return book;
        }
    }
    ```
    
- ì£¼ë¬¸ ê²€ìƒ‰ ê¸°ëŠ¥
    - JPAì—ì„œ ë™ì ì¿¼ë¦¬ë¥¼ ì–´ë–»ê²Œ ì²˜ë¦¬í•˜ëŠ”ì§€!
    - ë™ì ì¿¼ë¦¬ë¥¼ í•´ê²°í•˜ëŠ” ë°©ë²•
        1. JPQL
            1. JPQL ì¿¼ë¦¬ë¥¼ ë¬¸ìë¡œ ìƒì„±í•˜ê¸´ ë²ˆê±°ë¡­ê³  ì‹¤ìˆ˜ë¡œ ì¸í•œ ë²„ê·¸ê°€ ì¶©ë¶„íˆ ë°œìƒ ê°€ëŠ¥í•¨.
        2. JPA Criteria
            1. JPA í‘œì¤€ ìŠ¤í™ì´ì§€ë§Œ ì‹¤ë¬´ì—ì„œ ì‚¬ìš©í•˜ê¸°ì— ë„ˆë¬´ ë³µì¡í•´ì„œ ì‹¤ë¬´ì—ì„œ ì•ˆì”€. 
            2. ê°€ì¥ ë©‹ì§„ í•´ê²°ì±…ì€ Querydslì´ ì œì‹œ. ì§€ê¸ˆì€ ì´ëŒ€ë¡œ ì§„í–‰í•¨.
    
    ```java
    // JPQL
        public List<Order> findAll(OrderSearch orderSearch) {
            String jpql = "select o From Order o join o.member m";
            boolean isFirstCondition = true;
    
            //ì£¼ë¬¸ ìƒíƒœ ê²€ìƒ‰
            if (orderSearch.getOrderStatus() != null) {
                if (isFirstCondition) {
                    jpql += " where";
                    isFirstCondition = false;
                } else {
                    jpql += " and";
                }
                jpql += " o.status = :status";
            }
    
            //íšŒì› ì´ë¦„ ê²€ìƒ‰
            if (StringUtils.hasText(orderSearch.getMemberName())) {
                if (isFirstCondition) {
                    jpql
                            += " where";
                    isFirstCondition = false;
                }
                else {
                    jpql+= " and";
                }
                jpql += " m.name like :name";
            }
            TypedQuery<Order> query = em.createQuery(jpql, Order.class)
                    .setMaxResults(1000); //ìµœëŒ€ 1000ê±´
            if (orderSearch.getOrderStatus() != null) {
                query = query.setParameter("status", orderSearch.getOrderStatus());
            }
            if (StringUtils.hasText(orderSearch.getMemberName())) {
            }
            query = query.setParameter("name", orderSearch.getMemberName());
            return query.getResultList();
        }
    
        //JPA Criteria
        public List<Order> findAllByCriteria(OrderSearch orderSearch) {
            CriteriaBuilder cb = em.getCriteriaBuilder();
            CriteriaQuery<Order> cq = cb.createQuery(Order.class);
            Root<Order> o = cq.from(Order.class);
            Join<Order, Member> m = o.join("member", JoinType.INNER); //íšŒì›ê³¼ ì¡°ì¸
            List<Predicate> criteria = new ArrayList<>();
    
            //ì£¼ë¬¸ ìƒíƒœ ê²€ìƒ‰
            if (orderSearch.getOrderStatus() != null) {
                Predicate status = cb.equal(o.get("status"),
                        orderSearch.getOrderStatus());
                criteria.add(status);
            }
    
            //íšŒì› ì´ë¦„ ê²€ìƒ‰
            if (StringUtils.hasText(orderSearch.getMemberName())) {
                Predicate name =
                        cb.like(m.<String>get("name"), "%" + orderSearch.getMemberName()
                                + "%");
                criteria.add(name);
            }
    
            cq.where(cb.and(criteria.toArray(new Predicate[criteria.size()])));
            TypedQuery<Order> query = em.createQuery(cq).setMaxResults(1000);
    
            return query.getResultList();
        }
    ```
    
    - í™•ì‹¤íˆ Querydslì´ ì¢‹ê¸´í•˜ë‹¤..

---
