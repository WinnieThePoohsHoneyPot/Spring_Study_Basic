## ğŸ¥¸ í™ˆ í™”ë©´ê³¼ ë ˆì´ì•„ì›ƒ

- HomeController.java

```java
@Controller
@Slf4j
public class HomeController {

    @RequestMapping("/")
    public String home() {
        log.info("home controller");
        return "home";
    }
}
```

## ğŸ¥¸ íšŒì› ë“±ë¡

- MemberForm.java

```java
@Getter @Setter
public class MemberForm {
    @NotEmpty(message="íšŒì› ì´ë¦„ì€ í•„ìˆ˜ ì…ë‹ˆë‹¤")
    private String name;
    private String city;
    private String street;
    private String zipcode;
}
```

- MemberController

```java
@Controller
@RequiredArgsConstructor
public class MemberController {
    private final MemberService memberService;

    @GetMapping("/members/new")
    public String createForm(Model model) {
        model.addAttribute("memberForm", new MemberForm());
        return "members/createMemberForm";
    }

    // ì—ëŸ¬ ë°œìƒì‹œ resultì— ì—ëŸ¬ê°€ ë‹´ê²¨ì„œ ì½”ë“œê°€ ì‹¤í–‰ë¨
    @PostMapping("/members/new")
    public String create(@Valid MemberForm memberForm, BindingResult result) {
        if (result.hasErrors()) {
            return "members/createMember";
        }

        Address address =  new Address(form.getCity(), form.getStreet(), form.getZipcode());

        Member member = new Member();
        member.setName(form.getName());
        member.setAddress(address);

        memberService.join(member);
        return "redirect:/";
    }
}
```

- ë‹¨ìˆœí•œ ì˜ˆì œì˜ ê²½ìš°ì—ì„œëŠ” ì—”í‹°í‹°ì™€ í¼ì„ ë§¤í•‘í•´ì„œ ì‚¬ìš©í•´ë„ ë˜ì§€ë§Œ ì‹¤ì œë¡œëŠ” ê°„ë‹¨í•œ ë°ì´í„°ë§Œ ë°›ì§€ ì•Šê¸° ë•Œë¬¸ì— í¼ì— ë§ëŠ” ì—”í‹°í‹°ë¡œ ë°ì´í„°ë¥¼ ë°›ëŠ” ê²ƒì„ ê¶Œì¥

## ğŸ¥¸ íšŒì› ëª©ë¡ ì¡°íšŒ

- ì •ë³´ë¥¼ `Model`ì— ë‹´ì•„ì„œ ì •ë³´ë¥¼ htmlì— ì „ë‹¬
- ì—”í‹°í‹°ëŠ” í•µì‹¬ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ë§Œ ê°€ì§€ê³  ìˆê³  í™”ë©´ì„ ìœ„í•œ ë¡œì§ì€ ì œì™¸
- í™”ë©´ì„ ìœ„í•œ ë¡œì§ì€ í¼ ê°ì²´ë‚˜ DTOë¥¼ ì‚¬ìš©í•´ì„œ í•´ê²°
- APIë¥¼ ë§Œë“¤ ë•Œ ì—”í‹°í‹°ë¥¼ ë°˜í™˜í•˜ë©´ ì•ˆë¨
  - ì—”í‹°í‹°ì— ë³€ê²½ì´ ìƒê²¼ì„ ë•Œ, APIì˜ ìŠ¤í™ë„ ë³€ê²½ë˜ê¸° ë•Œë¬¸ì— ë¶ˆì•ˆì •í•œ APIê°€ ë¨
  - ì—”í‹°í‹°ì˜ í•„ë“œê°€ ë…¸ì¶œë¨

```java
@Controller
@RequiredArgsConstructor
public class MemberController {
    @GetMapping("/members")
    public String list(Model model) {
        List<Member> members = memberService.findMembers();
        model.addAttribute("members", members);
        return "members/memberList";
    }
}
```

## ğŸ¥¸ ìƒí’ˆ ë“±ë¡

- BookForm

```java
@Getter @Setter
public class BookForm {
    private Long id;

    private String name;
    private int price;
    private int stockQuantity;

    private String author;
    private String isbn;
}
```

- ItemController

```java
@Controller
@RequiredArgsConstructor
public class ItemController {
    private final ItemService itemService;

    @GetMapping("/items/new")
    public String createForm(Model model) {
        model.addAttribute("form", new BookForm());
        return "items/createItemForm";
    }

    @PostMapping("/items/new")
    public STring create(BookForm form) {
        Book book = new Book();
        // setterì„ ì œê±°í•˜ëŠ” ê²ƒì´ ê°€ì¥ ì¢‹ì€ ì„¤ê³„!!
        book.setName(form.getName());
        book.setPrice(form.getPrice());
        book.setStockQuantity(form.getStockQuantity());
        book.setAuthor(form.getAuthor());
        book.setIsbn(form.getIsbn());

        itemService.saveItem(book);
        return "redirect:/";
    }
}
```

## ğŸ¥¸ ìƒí’ˆ ëª©ë¡

- ItemController

```java
@Controller
@RequiredArgsConstructor
public class ItemController {
    @GetMapping("/items")
    public String list(Model model) {
        List<Item> items = itemService.findItems();
        model.addAttribute("items", items);
        return "items/itemList";
    }
}
```

## ğŸ¥¸ ìƒí’ˆ ìˆ˜ì •

- ItemController

```java
@Controller
@RequiredArgsConstructor
public class ItemController {
    @GetMapping("items/{itemId}/edit")
    public String updateItemForm(@PathVariable("itemId") Long itemId, Model model) {
        Book item = itemService.findOne(itemId);

        BookForm form = new BookForm();
        form.setId(item.getId());
        form.setPrice(form.getPrice());
        form.setStockQuantity(form.getStockQuantity());
        form.setAuthor(item.getAuthor());
        form.setIsbn(item.getIsbn());

        model.addAttribute("form", form);
        return "items/updateItemForm";
    }

    @PostMapping("items/{itemId}/edit")
    public String updateItem(@ModelAttribute("form") BookForm bookForm) {
        Book book = new Book();
        book.setId(bookForm.getId()); // ì•„ì´ë”” ì·¨ì•½ì  ì£¼ì˜
        book.setName(bookForm.getName());
        book.setPrice(bookForm.getPrice());
        book.setStockQuantity(bookForm.getStockQuantity());
        book.setIsbn(bookForm.getIsbn());

        itemService.saveItem(book);
        return "redirect:/items";
    }
}
```

## ğŸ¥¸ ë³€ê²½ ê°ì§€ì™€ ë³‘í•©(merge)

_JPAì—ì„œ ì •ë§ ì¤‘ìš”í•œ ë‚´ìš©ì´ë‹ˆ ì˜ ìˆ™ì§€í•  ê²ƒ!_

```java
@RunWith(SpringRunner.class)
@SpringBootTest
public class ItemUpdateTest {
    @Autowired
    EntityManager em;

    @Test
    public void updateTest() throws Exception {
        Book book = em.find(Book.class, 1L);

        // TX
        book.setName("asdfasdf");

        //ë³€ê²½ ê°ì§€ == dirty checking
        // TX commit
    }
}
```

### ì¤€ì˜ì† ì—”í‹°í‹°

- ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ê°€ ë”ëŠ” ê´€ë¦¬í•˜ì§€ ì•ŠëŠ” ì—”í‹°í‹°
- ì´ë¯¸ DBì— ì €ì¥ë˜ì–´ ì‹ë³„ìê°€ ì¡´ì¬í•˜ëŠ” ê²½ìš°, ì„ì˜ë¡œ ë§Œë“¤ì–´ë‚¸ ì—”í‹°í‹°ë„ ê¸°ì¡´ ì‹ë³„ìë¥¼ ê°€ì§€ê³  ìˆìœ¼ë©´ ì¤€ì˜ì† ì—”í‹°í‹°ë¡œ ë³¼ ìˆ˜ ìˆìŒ
- JPAê°€ ê¸°ë³¸ì ìœ¼ë¡œ ë³€ê²½ì„ ê´€ë¦¬í•˜ì§€ ì•Šê¸° ë•Œë¬¸ì— DBì— ì—…ë°ì´íŠ¸ê°€ ì¼ì–´ë‚˜ì§€ ì•ŠìŒ

### ì¤€ì˜ì† ì—”í‹°í‹°ì˜ ìˆ˜ì • - ë³€ê²½ ê°ì§€ ê¸°ëŠ¥ ì‚¬ìš©

- ê¶Œì¥í•˜ëŠ” ê¸°ëŠ¥
- íŠ¸ëœì­ì…˜ ì•ˆì—ì„œ ì—”í‹°í‹°ë¥¼ ë‹¤ì‹œ ì¡°íšŒí•˜ì—¬ ë³€ê²½í•  ê°’ì„ ì„ íƒí•˜ê³  íŠ¸ëœì­ì…˜ ì»¤ë°‹ ì‹œì ì— ë³€ê²½ ê°ì§€(Dirty Checking)ì´ ë™ì‘í•´ì„œ ë°ì´í„°ë² ì´ìŠ¤ì— UPDATE SQL ì‹¤í–‰
- setterë¡œ ë°ì´í„°ë¥¼ ë³€ê²½í•˜ëŠ” ê²ƒë³´ë‹¤, ì˜ë¯¸ìˆëŠ” ë©”ì„œë“œë¥¼ ì„¤ê³„í•´ì„œ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ ê°€ë…ì„±(ë³€ê²½ ì¶”ì )ì—ì„œ ì¢‹ë‹¤!

```java
@Transactional
public void updateItem(Long itemId, Book param) {
    // ì˜ì† ì—”í‹°í‹°ì˜ ë³€ê²½ ê°ì§€ ê¸°ëŠ¥ ì‚¬ìš©
    Item findItem = itemRepository.findOne(itemId);
    findItem.setPrice(param.getPrice());
    findItem.setName(param.getName());
    findItem.setStockQuantity(param.getStockQuantity());
}
```

### ì¤€ì˜ì† ì—”í‹°í‹°ì˜ ìˆ˜ì • - ë³‘í•©(merge) ì‚¬ìš©

- ë³‘í•© : ì¤€ì˜ì† ìƒíƒœì˜ ì—”í‹°í‹°ë¥¼ ì˜ì† ìƒíƒœë¡œ ë³€ê²½í•  ë•Œ ì‚¬ìš©í•˜ëŠ” ê¸°ëŠ¥

```java
@Transactional
void update(Item itemParam) {
    Item mergeItem = em.merge(item);
}
```

#### ë™ì‘ë°©ì‹

1. `merge()` ì‹¤í–‰
2. íŒŒë¼ë¯¸í„°ë¡œ ë„˜ì–´ì˜¨ ì¤€ì˜ì† ì—”í‹°í‹°ì˜ ì‹ë³„ì ê°’ìœ¼ë¡œ 1ì°¨ ìºì‹œì—ì„œ ì—”í‹°í‹° ì¡°íšŒ, ë§Œì•½ 1ì°¨ ìºì‹œì— ì—”í‹°í‹°ê°€ ì—†ë‹¤ë©´ DBì—ì„œ ì—”í‹°í‹°ë¥¼ ì¡°íšŒí•˜ê³  1ì°¨ ìºì‹œì— ì €ì¥
3. ì¡°íšŒí•œ ì˜ì† ì—”í‹°í‹°ì— ì¤€ì˜ì† ì—”í‹°í‹° ê°’ìœ¼ë¡œ êµì²´
4. ì˜ì† ìƒíƒœì¸ ì¡°íšŒí•œ ì˜ì† ì—”í‹°í‹° ë°˜í™˜

#### ì£¼ì˜

- ë³€ê²½ ê°ì§€ ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ë©´ ì›í•˜ëŠ” ì†ì„±ë§Œ ì„ íƒí•´ì„œ ë³€ê²½í•  ìˆ˜ ìˆì§€ë§Œ, ë³‘í•©ì„ ì‚¬ìš©í•˜ë©´ ëª¨ë“  ì†ì„±ì´ ë³€ê²½
- ë³‘í•©ì‹œ ê°’ì´ ì—†ìœ¼ë©´ `null`ë¡œ ì—…ë°ì´íŠ¸ í•  ìœ„í—˜ì´ ìˆìŒ

### ê°€ì¥ ì¢‹ì€ í•´ê²° ë°©ë²•

- **ì—”í‹°í‹°ë¥¼ ë³€ê²½í•  ë•ŒëŠ” í•­ìƒ ë³€ê²½ ê°ì§€ ì‚¬ìš©**
- ì»¨íŠ¸ë¡¤ëŸ¬ì—ì„œ ì–´ì„¤í”„ê²Œ ì—”í‹°í‹°ë¥¼ ìƒì„±í•˜ì§€ ë§ ê²ƒ
- íŠ¸ëœì­ì…˜ì´ ìˆëŠ” ì„œë¹„ìŠ¤ ê³„ì¸µì— ì‹ë³„ìì™€ ë³€ê²½í•  ë°ì´í„°ë¥¼ ëª…í™•í•˜ê²Œ ì „ë‹¬(íŒŒë¼ë¯¸í„°ë‚˜ DTO ê°ì²´ ì‚¬ìš©)
- íŠ¸ëœì ì…˜ì´ ìˆëŠ” ì„œë¹„ìŠ¤ ê³„ì¸µì— ì˜ì† ìƒíƒœì˜ ì—”í‹°í‹°ë¥¼ ì¡°íšŒí•˜ê³  ì—”í‹°í‹°ì˜ ë°ì´í„° ì§ì ‘ ë³€ê²½
  - íŠ¸ëœì­ì…˜ ì»¤ë°‹ ì‹œì ì— ë³€ê²½ ê°ì§€ ì‹¤í–‰

## ğŸ¥¸ ìƒí’ˆ ì£¼ë¬¸

- OrderController

```java
@Controller
@RequiredArgsConstructor
public class OrderController {
    private final OrderService orderService;
    private final MemberService memberService;
    private final ItemService itemService;

    @GetMapping
    public String createForm(Model model) {
        List<Member> members = memberService.findMembers();
        List<Item> items = itemService.findItems();

        model.addAttribute("members", members);
        model.addAttribute("items", items);

        return "order/orderForm";
    }

    @PostMapping("/order")
    public String order(@RequestParam("memberId") Long memberId,
                        @RequestParam("itemId") Long itemId,
                        @RequestParam("count") int count) {
        orderService.order(memberId, itemId, count);
        return "redirect:/orders";
    }
}
```

- ì¡°íšŒê°€ ì•„ë‹Œ í•µì‹¬ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì€ Controllerê°€ ì•„ë‹Œ Serviceê°€ í•˜ëŠ” ê²ƒì´ ì¢‹ìŒ

## ğŸ¥¸ ì£¼ë¬¸ ëª©ë¡ ê²€ìƒ‰, ì·¨ì†Œ

- OrderSearch

```java
@Getter @Setter
public class OrderSearch {
    private String memberName;
    private OrderStatus orderStatus;
}
```

- OrderService
  - ë‹¨ìˆœ ì¡°íšŒ ê¸°ëŠ¥ì˜ ê²½ìš° êµ¬ì¡°ì— ë”°ë¼ ë‹¤ë¥´ì§€ë§Œ ìœ„ì„í•˜ì§€ ì•Šê³  Controllerì—ì„œ Repositoryë¡œ ë°”ë¡œ ì ‘ê·¼í•´ë„ ê´œì°®ìŒ

```java
@Service
@Transactional(readOnly = true)
@RequiredArgsConstructor
public class OrderService {
    public List<Order> findOrders(OrderSearch orderSearch) {
        return orderRepository.findAllByString(orderSearch);
    }
}
```

- OrderController

```java
@Controller
@RequiredArgsConstructor
public class OrderController {
    @GetMapping("/orders")
    public String orderList(@ModelAttribute("orderSearch") OrderSearch orderSearch, Model model) {
        List<Order> orders = orderService.findOrders(orderSearch);
        model.addAttribute("orders", orders);

        return "order/orderList";
    }

    @PostMapping("/orders/{orderId}/cancel")
    public String cancelOrder(@PathVariable("orderId") Long orderId) {
        orderService.cancelOrder(orderId);
        return "redirect:/orders";
    }
}
```
